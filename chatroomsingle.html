<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>Long-Poll Chat Rooms</title>
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;height:100vh}
header{background:#222;padding:8px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
#roomsList{background:#222;max-height:150px;overflow-y:auto;padding:6px}
.roomEntry{padding:4px;margin:2px 0;background:#333;border-radius:6px;cursor:pointer}
main{flex:1;overflow-y:auto;padding:10px}
.msg{margin:6px 0;padding:6px 10px;background:#333;border-radius:6px;max-width:70%}
.msg.me{background:#0af;color:#000;margin-left:auto}
footer{display:flex;gap:6px;padding:8px;background:#222}
input,button{padding:6px;border-radius:4px;border:1px solid #444;background:#000;color:#eee}
button{cursor:pointer}
</style>
</head>
<body>
<header>
  <input id="server" placeholder="Server URL (https://...)" style="width:180px"/>
  <input id="room" placeholder="Room"/>
  <input id="pass" placeholder="Password"/>
  <input id="user" placeholder="Username"/>
  <button onclick="createRoom()">Create</button>
  <button onclick="joinRoom()">Join</button>
  <button onclick="fetchRooms()">Refresh Rooms</button>
</header>
<div id="roomsList"></div>
<main id="chat"></main>
<footer>
  <input id="msg" placeholder="Type..." style="flex:1"/>
  <button onclick="sendMsg()">Send</button>
</footer>

<script>
let server, room, pass, user;
let since = 0;
let isHost = false;

// helpers
function api(path,data){
  return fetch(server+path,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(data)
  }).then(r=>r.json());
}
function log(text,me){
  const div=document.createElement("div");
  div.className="msg"+(me?" me":"");
  div.innerHTML=`<div>${text}</div>`;
  document.getElementById("chat").appendChild(div);
  div.scrollIntoView();
}

// room create
async function createRoom(){
  server=document.getElementById("server").value;
  room=document.getElementById("room").value;
  pass=document.getElementById("pass").value;
  user=document.getElementById("user").value;
  const r=await api("/create",{room,password:pass,host:user});
  if(r.ok){ isHost=true; log("Room created."); start(); }
  else log("Error: "+(r.error||"failed"));
}

// join room
async function joinRoom(){
  server=document.getElementById("server").value;
  room=document.getElementById("room").value;
  pass=document.getElementById("pass").value;
  user=document.getElementById("user").value;
  const r=await api("/join",{room,password:pass,user});
  if(r.ok){ isHost=false; log("Joined room."); start(); }
  else log("Error: "+(r.error||"failed"));
}

// fetch rooms
async function fetchRooms(){
  server=document.getElementById("server").value;
  const res=await fetch(server+"/rooms");
  const list=await res.json();
  const div=document.getElementById("roomsList");
  div.innerHTML="";
  list.forEach(r=>{
    const e=document.createElement("div");
    e.className="roomEntry";
    e.textContent=`${r.name} (host: ${r.host}) ${r.hasPassword?"ðŸ”’":""}`;
    e.onclick=()=>{ document.getElementById("room").value=r.name; log(`Selected room ${r.name}`); };
    div.appendChild(e);
  });
}

// polling
async function poll(){
  try{
    const res=await fetch(`${server}/recv?room=${encodeURIComponent(room)}&user=${encodeURIComponent(user)}&since=${since}`);
    const msgs=await res.json();
    for(const m of msgs){
      since=Math.max(since,m.id);
      log(`<b>${m.user}:</b> ${m.text}`, m.user===user);
    }
  }catch(e){ console.error(e); }
  setTimeout(poll,200);
}

// heartbeat
function heartbeat(){
  if(isHost) api("/join",{room,user,password:pass}); 
  setTimeout(heartbeat,10000);
}

function start(){ since=0; poll(); heartbeat(); }

async function sendMsg(){
  const text=document.getElementById("msg").value;
  if(!text) return;
  document.getElementById("msg").value="";
  await api("/send",{room,user,text});
}
</script>
</body>
</html>
